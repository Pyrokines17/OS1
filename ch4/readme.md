Важное:
- Локальные переменные не могут выходить из области функции
- Нельзя использовать `free` не по инициализируемому адресу

---

Команды:
- `ps aux | grep prog | grep -v grep`
- `vim  /proc/<pid>/maps`
- `nm`/`readelf`
- `export VAR=12`
- `watch -d -n1 cat /proc/<pid>/maps`

---

Окружение (environment) или среда - это набор пар ПЕРЕМЕННАЯ=ЗНАЧЕНИЕ, доступный каждому пользовательскому процессу. Иными словами, окружение - это набор переменных окружения. Про полезность окружения можно говорить долго, но основное его назначение - заставить одни и те же программы работать у разных пользователей по-разному. 

Теперь разберемся с тем, откуда берется окружение. Любая запущенная и работающая в Linux программа - это процесс. Запуская дважды одну и ту же программу, вы получаете два процесса. У каждого процесса (кроме init) есть свой процесс-родитель. Когда вы набираете в командной строке vim, в системе появляется новый процесс, соответствующий текстовому редактору vim; родительским процессом здесь будет оболочка (bash, например). Для самой оболочки новый процесс будет дочерним. 

Сейчас же важно одно: **новый процесс получает копию родительского окружения.** Из этого правила существует несколько исключений, но мы пока об этом говорить не будем. Важно то, что у каждого процесса своя **независимая копия** окружения, с которой процесс может делать все что угодно. Если процесс завершается, то копия теряется; если процесс породил другой, дочерний процесс, то этот новый процесс получает копию окружения своего родителя.

---

`mmap`, `munmap` - отражает файлы или устройства в памяти или снимает их отражение. Функция **`mmap`** отражает *length* байтов, начиная со смещения *offset* файла (или другого объекта), определенного файловым описателем *`fd`*, в память, начиная с адреса *start*. Последний параметр (адрес) необязателен, и обычно бывает равен 0. Настоящее местоположение отраженных данных возвращается самой функцией **`mmap`**, и никогда не бывает равным 0.

Аргумент *`prot`* описывает желаемый режим защиты памяти (он не должен конфликтовать с режимом открытия файла). Оно является либо **`PROT_NONE`** либо побитовым ИЛИ одного или нескольких флагов `PROT_*`.

- **`PROT_EXEC`** (данные в страницах могут исполняться);
- **`PROT_READ`** (данные можно читать);
- **`PROT_WRITE`** (в эту область можно записывать информацию);
- **`PROT_NONE`** (доступ к этой области памяти запрещен).

---

  Параметр *flags* задает тип отражаемого объекта, опции отражения и указывает, принадлежат ли отраженные данные только этому процессу или их могут читать другие. 
  
  Он состоит из комбинации следующих битов:
  - **MAP_FIXED**
    Не использовать другой адрес, если адрес задан в параметрах функции. Если заданный адрес не может быть использован, то функция **`mmap`** вернет сообщение об ошибке. Если используется MAP_FIXED, то *start* должен быть пропорционален размеру страницы. Использование этой опции не рекомендуется.
  - **MAP_SHARED**
    Разделить использование этого отражения с другими процессами, отражающими тот же объект. Запись информации в эту область памяти будет эквивалентна записи в файл. Файл может не обновляться до вызова функций **[`msync`](https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=msync&category=2)**(2) или **[`munmap`](https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=munmap&category=2)**(2)
  - **MAP_PRIVATE**
    Создать `неразделяемое` отражение с механизмом `copy-on-write`. Запись в эту область памяти не влияет на файл. Не определено, являются или нет изменения в файле после вызова **`mmap`** видимыми в отраженном диапазоне.

  Вы должны задать либо MAP_SHARED, либо MAP_PRIVATE (Эти три флага описаны в `POSIX.1b` (бывшем `POSIX.4`) and `SUSv2`)
  
  В Linux также анализируются следующие нестандартные флаги:
  - **`MAP_NORESERVE`**
	  (Используется вместе с MAP_PRIVATE.) Не выделяет страницы пространства подкачки для этого отображения. Если пространство подкачки выделяется, то это частное пространство копирования-при-записи может быть изменено. Если оно не выделено, то можно получить `SIGSEGV` при записи и отсутствии доступной памяти.
  - **`MAP_LOCKED`**
	  (Linux 2.5.37 и выше) Блокировать страницу или размеченную область в памяти так, как это делает **`mlock`**. Этот флаг игнорируется в старых ядрах.
  - **`MAP_GROWSDOWN`**
	  Используется для стеков. Для `VM` системы ядра обозначает, что отображение должно распространяться вниз по памяти.
  - **`MAP_ANONYMOUS`**
	  Отображение не резервируется ни в каком файле; аргументы *`fd`* и *`offset`* игнорируются. Этот флаг вместе с MAP_SHARED реализован с Linux 2.4.

  Адрес *start* должно быть кратен размеру страницы. Все страницы, содержащие часть указанного диапазона, не отображены, и последующие ссылки на эти страницы будут генерировать `SIGSEGV`. Это не будет являться ошибкой, если указанный диапазон не содержит отображенных страниц. Для отображений '`файл-бэкэнд`' поле **`st_atime`** отображаемого файла может быть обновлено в любой момент между **`mmap`** и соответствующим снятием отображения; первое обращение к отображенной странице обновит поле, если оно до этого уже не было обновлено.
  
  ---

  Функция `exec` (execute) загружает и запускает другую программу. Таким образом, новая программа полностью замещает текущий процесс. Новая программа начинает свое выполнение с функции `main`. Все файлы вызывающей программы остаются открытыми. Они также являются доступными новой программе. Используется шесть различных вариантов функций `exec`.

  ```c
  #include <unistd.h>
  
  int execl(char *name, char *arg0, ... /*NULL*/);
  int execv(char *name, char *argv[]);
  int execle(char *name, char *arg0, ... /*,NULL, char *envp[]*/);
  int execve(char *name, char *arv[], char *envp[]);
  int execlp(char *name, char *arg0, ... /*NULL*/);
  int execvp(char *name, char *argv[]);
  ```
  
  Вызов `exec` происходит таким образом, что переданная в качестве аргумента программа загружается в память вместо старой, которая вызвала `exec`. Старой программе больше не доступны сегменты памяти, которые перезаписаны новой программой.
  
  Суффиксы `l, v, p, e` в именах функций определяют формат и объем аргументов, а также каталоги, в которых нужно искать загружаемую программу:
  
  - l (список) 
	  Аргументы командной строки передаются в форме списка `arg0, arg1.... argn, NULL`. Эту форму используют, если количество аргументов известно;
  - v (vector)
	  Аргументы командной строки передаются в форме вектора `argv[]`. Отдельные аргументы адресуются через `argv [0], argv [1]... argv [n]`. Последний аргумент (`argv [n]`) должен быть указателем `NULL`;
  - p (path)
	  Обозначенный по имени файл ищется не только в текущем каталоге, но и в каталогах, определенных переменной среды `PATH`;
  - e (среда)
	  Функция ожидает список переменных среды в виде вектора (`envp []`) и не использует текущей среды.
